<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Pick Settings ‚Äì Players & Branding</title>
  <meta name="description" content="Manage shared player lists, colors, and emojis to keep every Daily Pick game on-brand across your team." />
  <meta name="keywords" content="daily pick settings, team roster, brand customization, stand-up tools" />

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://dailypick.dev/apps/settings/">
  <meta property="og:title" content="Daily Pick Settings ‚Äì Players & Branding">
  <meta property="og:description" content="Manage shared player lists, colors, and emojis to keep every Daily Pick game on-brand across your team.">
  <meta property="og:image" content="https://dailypick.dev/assets/og-image-main.png">
  <meta property="og:image:alt" content="Settings panel for customizing Daily Pick players and branding">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://dailypick.dev/apps/settings/">
  <meta name="twitter:title" content="Daily Pick Settings ‚Äì Players & Branding">
  <meta name="twitter:description" content="Manage shared player lists, colors, and emojis to keep every Daily Pick game on-brand across your team.">
  <meta name="twitter:image" content="https://dailypick.dev/assets/og-image-main.png">
  <meta name="twitter:image:alt" content="Settings panel for customizing Daily Pick players and branding">

  <link rel="canonical" href="https://dailypick.dev/apps/settings/" />

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/site.webmanifest">
  <link rel="shortcut icon" href="/assets/favicon/favicon.ico">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="/assets/css/glass.css">
  <link rel="stylesheet" href="style.css">
  <script src="/assets/js/brand-config.js" defer></script>
</head>

<body>
  {% include "bg-orbs.html" %}
  {% include "header.html" %}

  <main class="settings-page" aria-labelledby="settingsHeading">
    <section class="settings-hero glass-card">
      <div>
        <p class="eyebrow">Control center</p>
        <h1 id="settingsHeading">Settings &amp; Brand Studio</h1>
        <p>Update the shared player roster used across our games and tailor the Daily Pick look-and-feel to match your
          team. Changes save to your browser and apply instantly.</p>
      </div>
      <div class="hero-actions">
        <a class="btn-link" href="/apps/wheel/">Jump into a game ‚Üí</a>
      </div>
    </section>

    <section class="settings-grid">
      <article class="settings-card glass-card" aria-labelledby="playersHeading">
        <div class="card-header">
          <h2 id="playersHeading">Player List</h2>
          <p>One list powers every picker. Add each teammate on its own line.</p>
        </div>
        <label for="playerNamesInput" class="sr-only">Player names</label>
        <textarea id="playerNamesInput" rows="8" spellcheck="false"></textarea>
        <p class="field-hint">Tip: paste from Slack or CSV, we clean it automatically.</p>
        <div class="button-row">
          <button id="savePlayersBtn" type="button">Save Players</button>
          <button id="resetPlayersBtn" type="button" class="ghost">Reset Names</button>
        </div>
        <p id="playersStatus" class="settings-status" aria-live="polite"></p>
      </article>

      <article class="settings-card glass-card" aria-labelledby="brandHeading">
        <div class="card-header">
          <h2 id="brandHeading">Brand Configuration</h2>
          <p>Use your own colors, emoji, and typography to make Daily Pick feel native to your team.</p>
        </div>

        <form id="brandForm" class="brand-form" novalidate>
          <div class="brand-grid">
            <label>
              Brand name
              <input type="text" id="brandNameInput" maxlength="32">
            </label>
            <label>
              Brand emoji / mark
              <input type="text" id="brandMarkInput" maxlength="4">
            </label>
            <label>
              Accent color
              <input type="color" id="accentColorInput">
            </label>
            <label>
              Accent (strong)
              <input type="color" id="accentStrongInput">
            </label>
            <label>
              Background color
              <input type="color" id="backgroundColorInput">
            </label>
            <label>
              Surface color
              <input type="color" id="surfaceColorInput">
            </label>
            <label>
              Text color
              <input type="color" id="textColorInput">
            </label>
            <label>
              Heading color
              <input type="color" id="headingColorInput">
            </label>
            <label>
              Subtle text color
              <input type="color" id="subtleTextColorInput">
            </label>
            <label>
              Border color
              <input type="color" id="borderColorInput">
            </label>
            <label>
              Font stack
              <input type="text" id="fontFamilyInput" placeholder="'Nunito', system-ui, sans-serif">
            </label>
            <label>
              Logo image URL (optional)
              <input type="url" id="logoUrlInput" placeholder="https://example.com/logo.png">
            </label>
          </div>
        </form>

        <div class="brand-preview" aria-live="polite">
          <div class="preview-header">
            <span class="preview-mark" aria-hidden="true">üéØ</span>
            <span class="preview-name">Daily Pick</span>
          </div>
          <p>Buttons, headers, and accents across the site will match these selections.</p>
          <button type="button" disabled>Sample Button</button>
        </div>

        <div class="button-row">
          <button id="saveBrandBtn" type="button">Save Brand</button>
          <button id="resetBrandBtn" type="button" class="ghost">Reset Brand</button>
        </div>
        <p id="brandStatus" class="settings-status" aria-live="polite"></p>
      </article>

      <article class="settings-card glass-card" aria-labelledby="integrationsHeading">
        <div class="card-header">
          <h2 id="integrationsHeading">Third-Party Integrations</h2>
          <p>Connect Daily Pick to your delivery tools to sync boards and participants automatically.</p>
        </div>

        <p class="integration-intro">Connections save to the Daily Pick Worker so you can safely reuse them from any device.<br>
          Tokens are masked after you save them. Use the Test Connection button to be sure Daily Pick can pull data.</p>

        <div class="integration-grid">
          <section class="integration-card" data-service="jira" aria-labelledby="integration-jira-heading">
            <header class="integration-card-header">
              <div class="integration-icon" aria-hidden="true">üóÇÔ∏è</div>
              <div>
                <h3 id="integration-jira-heading">Jira</h3>
                <p>Create issues and sync assignees in a Jira project.</p>
              </div>
            </header>
            <label class="integration-toggle">
              <input type="checkbox" class="integration-enabled">
              <span>Enable connection</span>
            </label>
            <label>
              Jira site URL
              <input type="url" class="integration-field" data-field="siteUrl" placeholder="https://yourteam.atlassian.net">
            </label>
            <label>
              Project key
              <input type="text" class="integration-resource" placeholder="e.g. DP">
            </label>
            <label>
              Account email
              <input type="email" class="integration-field" data-field="email" placeholder="you@company.com">
            </label>
            <label>
              API token
              <input type="password" class="integration-token" placeholder="Paste a Jira API token">
            </label>
            <fieldset>
              <legend>Sync options</legend>
              <label class="checkbox">
                <input type="checkbox" class="integration-sync-boards">
                <span>Send Daily Pick cards to Jira issues</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" class="integration-sync-players">
                <span>Map saved players to Jira assignees</span>
              </label>
            </fieldset>
            <p class="integration-token-preview" aria-live="polite"></p>
            <p class="integration-status" aria-live="polite"></p>
            <div class="button-row">
              <button type="button" class="integration-save">Save Connection</button>
              <button type="button" class="ghost integration-test">Test Connection</button>
              <button type="button" class="ghost integration-disconnect">Disconnect</button>
            </div>
          </section>

          <section class="integration-card" data-service="trello" aria-labelledby="integration-trello-heading">
            <header class="integration-card-header">
              <div class="integration-icon" aria-hidden="true">üóíÔ∏è</div>
              <div>
                <h3 id="integration-trello-heading">Trello</h3>
                <p>Keep cards in sync with a Trello board list.</p>
              </div>
            </header>
            <label class="integration-toggle">
              <input type="checkbox" class="integration-enabled">
              <span>Enable connection</span>
            </label>
            <label>
              Board or list URL
              <input type="url" class="integration-resource" placeholder="https://trello.com/b/...">
            </label>
            <label>
              API key
              <input type="text" class="integration-field" data-field="apiKey" placeholder="Trello API key">
            </label>
            <label>
              API token
              <input type="password" class="integration-token" placeholder="Paste a Trello API token">
            </label>
            <fieldset>
              <legend>Sync options</legend>
              <label class="checkbox">
                <input type="checkbox" class="integration-sync-boards">
                <span>Append Daily Pick action items to the board</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" class="integration-sync-players">
                <span>Invite saved players as members</span>
              </label>
            </fieldset>
            <p class="integration-token-preview" aria-live="polite"></p>
            <p class="integration-status" aria-live="polite"></p>
            <div class="button-row">
              <button type="button" class="integration-save">Save Connection</button>
              <button type="button" class="ghost integration-test">Test Connection</button>
              <button type="button" class="ghost integration-disconnect">Disconnect</button>
            </div>
          </section>

          <section class="integration-card" data-service="github" aria-labelledby="integration-github-heading">
            <header class="integration-card-header">
              <div class="integration-icon" aria-hidden="true">üêô</div>
              <div>
                <h3 id="integration-github-heading">GitHub</h3>
                <p>Open issues or discussions directly from Daily Pick.</p>
              </div>
            </header>
            <label class="integration-toggle">
              <input type="checkbox" class="integration-enabled">
              <span>Enable connection</span>
            </label>
            <label>
              Repository full name
              <input type="text" class="integration-resource" placeholder="owner/repository">
            </label>
            <label>
              Personal access token
              <input type="password" class="integration-token" placeholder="Paste a GitHub token">
            </label>
            <fieldset>
              <legend>Sync options</legend>
              <label class="checkbox">
                <input type="checkbox" class="integration-sync-boards">
                <span>Create issues from Daily Pick cards</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" class="integration-sync-players">
                <span>Add players as collaborators when possible</span>
              </label>
            </fieldset>
            <p class="integration-token-preview" aria-live="polite"></p>
            <p class="integration-status" aria-live="polite"></p>
            <div class="button-row">
              <button type="button" class="integration-save">Save Connection</button>
              <button type="button" class="ghost integration-test">Test Connection</button>
              <button type="button" class="ghost integration-disconnect">Disconnect</button>
            </div>
          </section>
        </div>
      </article>
    </section>

    <section class="settings-card glass-card tips">
      <h2>How it works</h2>
      <ul>
        <li>Settings are stored locally in your browser via <code>localStorage</code>.</li>
        <li>Every game loads the Players List before a match and applies your Brand
            Configuration on page load.</li>
        <li>Need to sync with teammates? Share your list via chat, then paste it here.</li>
      </ul>
    </section>
  </main>

  {% include "footer.html" %}

  <script>
    (() => {
      const DEFAULT_NAMES = ['Kate', 'Andre', 'Juan', 'Dmytro', 'Vetura', 'Zachary', 'Lindsay'];
      const PLAYERS_KEY = 'namesList';
      const BRAND_CONFIG_KEY = 'brandConfig';
      const DEFAULT_BRAND = {
        brandName: 'Daily Pick',
        brandMark: 'üéØ',
        accentColor: '#3498db',
        accentStrong: '#2980b9',
        backgroundColor: '#f4f7f6',
        surfaceColor: '#ffffff',
        textColor: '#34495e',
        headingColor: '#2d3e50',
        subtleTextColor: '#7f8c8d',
        borderColor: '#dde4eb',
        fontFamily: "'Nunito', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
        logoUrl: '',
      };

      const playerNamesInput = document.getElementById('playerNamesInput');
      const savePlayersBtn = document.getElementById('savePlayersBtn');
      const resetPlayersBtn = document.getElementById('resetPlayersBtn');
      const playersStatus = document.getElementById('playersStatus');

      const brandInputs = {
        brandName: document.getElementById('brandNameInput'),
        brandMark: document.getElementById('brandMarkInput'),
        accentColor: document.getElementById('accentColorInput'),
        accentStrong: document.getElementById('accentStrongInput'),
        backgroundColor: document.getElementById('backgroundColorInput'),
        surfaceColor: document.getElementById('surfaceColorInput'),
        textColor: document.getElementById('textColorInput'),
        headingColor: document.getElementById('headingColorInput'),
        subtleTextColor: document.getElementById('subtleTextColorInput'),
        borderColor: document.getElementById('borderColorInput'),
        fontFamily: document.getElementById('fontFamilyInput'),
        logoUrl: document.getElementById('logoUrlInput'),
      };
      const saveBrandBtn = document.getElementById('saveBrandBtn');
      const resetBrandBtn = document.getElementById('resetBrandBtn');
      const brandStatus = document.getElementById('brandStatus');
      const brandPreview = document.querySelector('.brand-preview');
      const previewName = brandPreview.querySelector('.preview-name');
      const previewMark = brandPreview.querySelector('.preview-mark');
      const previewButton = brandPreview.querySelector('button');
      const integrationEndpoint = '/api/integrations/config';
      const integrationCards = Array.from(document.querySelectorAll('.integration-card'));

      function showStatus(el, message) {
        if (!el) return;
        el.textContent = message;
        setTimeout(() => { el.textContent = ''; }, 4000);
      }

      function normalizeNamesInput(raw) {
        if (!raw) return [];
        return raw
          .split(/[\n,]+/)
          .map(name => name.trim())
          .filter(Boolean);
      }

      function loadPlayers() {
        const stored = localStorage.getItem(PLAYERS_KEY);
        let names = DEFAULT_NAMES;
        if (stored) {
          try {
            const parsed = JSON.parse(stored);
            if (Array.isArray(parsed) && parsed.length) {
              names = parsed;
            }
          } catch {
            names = DEFAULT_NAMES;
          }
        }
        if (playerNamesInput) {
          playerNamesInput.value = names.join('\n');
        }
      }

      function savePlayers() {
        if (!playerNamesInput) return;
        const names = normalizeNamesInput(playerNamesInput.value);
        const toPersist = names.length ? names : DEFAULT_NAMES;
        playerNamesInput.value = toPersist.join('\n');
        localStorage.setItem(PLAYERS_KEY, JSON.stringify(toPersist));
        showStatus(playersStatus, `Saved ${toPersist.length} player${toPersist.length === 1 ? '' : 's'}.`);
      }

      function resetPlayers() {
        if (!playerNamesInput) return;
        localStorage.removeItem(PLAYERS_KEY);
        playerNamesInput.value = DEFAULT_NAMES.join('\n');
        showStatus(playersStatus, 'Reverted to default names.');
      }

      function safeParseBrandConfig(raw) {
        if (!raw) return null;
        try {
          const parsed = JSON.parse(raw);
          return typeof parsed === 'object' && parsed !== null ? parsed : null;
        } catch {
          return null;
        }
      }

      function loadBrand() {
        const stored = safeParseBrandConfig(localStorage.getItem(BRAND_CONFIG_KEY));
        const data = { ...DEFAULT_BRAND, ...stored };
        Object.entries(brandInputs).forEach(([key, input]) => {
          if (input) {
            input.value = data[key] ?? '';
          }
        });
        updatePreview(data);
      }

      function collectBrandForm(includeBlanks = false) {
        const data = {};
        Object.entries(brandInputs).forEach(([key, input]) => {
          if (!input) return;
          const value = input.value.trim();
          if (value || includeBlanks) {
            data[key] = value;
          }
        });
        return data;
      }

      function updatePreview(configOverride) {
        const merged = { ...DEFAULT_BRAND, ...configOverride };
        brandPreview.style.setProperty('--preview-accent', merged.accentColor);
        brandPreview.style.setProperty('--preview-surface', merged.surfaceColor);
        brandPreview.style.setProperty('--preview-text', merged.textColor);
        brandPreview.style.setProperty('--preview-heading', merged.headingColor);
        brandPreview.style.setProperty('--preview-border', merged.borderColor);
        brandPreview.style.setProperty('--preview-font', merged.fontFamily);
        previewName.textContent = merged.brandName;
        previewMark.textContent = merged.brandMark;
        previewButton.style.background = merged.accentColor;
        previewButton.style.borderColor = merged.accentStrong;
      }

      function saveBrand() {
        const formData = collectBrandForm();
        const merged = { ...DEFAULT_BRAND, ...formData };
        localStorage.setItem(BRAND_CONFIG_KEY, JSON.stringify(merged));
        window.dispatchEvent(new CustomEvent('brandConfigUpdated', { detail: merged }));
        updatePreview(merged);
        showStatus(brandStatus, 'Brand updated.');
      }

      function resetBrand() {
        Object.entries(brandInputs).forEach(([key, input]) => {
          if (input) input.value = DEFAULT_BRAND[key] ?? '';
        });
        localStorage.removeItem(BRAND_CONFIG_KEY);
        window.dispatchEvent(new CustomEvent('brandConfigUpdated', { detail: DEFAULT_BRAND }));
        updatePreview(DEFAULT_BRAND);
        showStatus(brandStatus, 'Brand reset to defaults.');
      }

      function setIntegrationStatus(card, message, tone = 'info') {
        const statusEl = card.querySelector('.integration-status');
        if (!statusEl) return;
        if (!message) {
          statusEl.textContent = '';
          delete statusEl.dataset.tone;
          return;
        }
        statusEl.textContent = message;
        statusEl.dataset.tone = tone;
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.textContent = '';
            delete statusEl.dataset.tone;
          }
        }, 4000);
      }

      function setIntegrationBusy(card, busy) {
        card.classList.toggle('is-busy', busy);
        const buttons = card.querySelectorAll('.integration-save, .integration-disconnect, .integration-test');
        buttons.forEach(btn => {
          btn.disabled = busy;
        });
      }

      function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        if (Number.isNaN(date.getTime())) {
          return '';
        }
        return date.toLocaleString();
      }

      async function refreshIntegrationCards() {
        if (!integrationCards.length) return;
        try {
          const response = await fetch(integrationEndpoint, { method: 'GET' });
          if (!response.ok) {
            throw new Error('Failed to load integration settings');
          }
          const data = await response.json();
          integrationCards.forEach((card) => {
            const service = card.dataset.service;
            const info = data?.services?.[service];
            const enabledInput = card.querySelector('.integration-enabled');
            const resourceInput = card.querySelector('.integration-resource');
            const tokenInput = card.querySelector('.integration-token');
            const syncBoardsInput = card.querySelector('.integration-sync-boards');
            const syncPlayersInput = card.querySelector('.integration-sync-players');
            const tokenPreview = card.querySelector('.integration-token-preview');
            const disconnectBtn = card.querySelector('.integration-disconnect');
            const fieldInputs = card.querySelectorAll('[data-field]');

            if (enabledInput) enabledInput.checked = Boolean(info?.enabled);
            if (resourceInput) resourceInput.value = info?.resource ?? '';
            if (tokenInput) tokenInput.value = '';
            if (syncBoardsInput) syncBoardsInput.checked = Boolean(info?.syncBoards);
            if (syncPlayersInput) syncPlayersInput.checked = Boolean(info?.syncPlayers);
            fieldInputs.forEach((input) => {
              const key = input.dataset.field;
              if (!key) return;
              input.value = info?.fields?.[key] ?? '';
            });
            if (tokenPreview) {
              if (info?.hasToken) {
                const preview = info.tokenPreview || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                const updated = formatTimestamp(info.lastUpdated);
                tokenPreview.textContent = `Token saved (${preview})${updated ? ` ‚Äì updated ${updated}` : ''}.`;
              } else {
                tokenPreview.textContent = 'No token stored yet.';
              }
            }
            if (disconnectBtn) {
              disconnectBtn.disabled = !(info?.hasToken || info?.enabled);
            }
            setIntegrationStatus(card, '');
          });
        } catch (error) {
          console.error('Integration load error', error);
          integrationCards.forEach((card) => {
            setIntegrationStatus(card, 'Unable to load integration settings.', 'error');
          });
        }
      }

      async function handleSaveIntegration(card, service) {
        const enabledInput = card.querySelector('.integration-enabled');
        const resourceInput = card.querySelector('.integration-resource');
        const tokenInput = card.querySelector('.integration-token');
        const syncBoardsInput = card.querySelector('.integration-sync-boards');
        const syncPlayersInput = card.querySelector('.integration-sync-players');
        const fieldInputs = card.querySelectorAll('[data-field]');

        const payload = {
          enabled: enabledInput?.checked ?? false,
          resource: resourceInput?.value?.trim() ?? '',
          syncBoards: syncBoardsInput?.checked ?? false,
          syncPlayers: syncPlayersInput?.checked ?? false,
        };

        if (fieldInputs.length) {
          payload.fields = {};
          fieldInputs.forEach((input) => {
            const key = input.dataset.field;
            if (!key) return;
            payload.fields[key] = input.value?.trim() ?? '';
          });
        }

        const tokenValue = tokenInput?.value?.trim();
        if (tokenValue) {
          payload.token = tokenValue;
        }

        try {
          setIntegrationBusy(card, true);
          setIntegrationStatus(card, 'Saving connection‚Ä¶');
          const response = await fetch(`${integrationEndpoint}/${service}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            const message = errorBody?.error || 'Unable to save connection.';
            throw new Error(message);
          }
          setIntegrationStatus(card, 'Connection saved.', 'success');
          if (tokenInput) {
            tokenInput.value = '';
          }
          await refreshIntegrationCards();
        } catch (error) {
          console.error(`Integration save error for ${service}`, error);
          setIntegrationStatus(card, error.message || 'Failed to save connection.', 'error');
        } finally {
          setIntegrationBusy(card, false);
        }
      }

      async function handleDisconnectIntegration(card, service) {
        try {
          setIntegrationBusy(card, true);
          setIntegrationStatus(card, 'Disconnecting‚Ä¶');
          const response = await fetch(`${integrationEndpoint}/${service}`, {
            method: 'DELETE',
          });
          if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            const message = errorBody?.error || 'Unable to disconnect.';
            throw new Error(message);
          }
          setIntegrationStatus(card, 'Connection removed.', 'success');
          await refreshIntegrationCards();
        } catch (error) {
          console.error(`Integration disconnect error for ${service}`, error);
          setIntegrationStatus(card, error.message || 'Failed to disconnect.', 'error');
        } finally {
          setIntegrationBusy(card, false);
        }
      }

      function summarizeIntegrationResult(service, data) {
        if (!data || typeof data !== 'object') {
          return 'Connection test succeeded.';
        }
        switch (service) {
          case 'jira': {
            const total = data.total ?? data.issues?.length ?? 0;
            return `Connection OK ‚Äì fetched ${total} Jira issue${total === 1 ? '' : 's'}.`;
          }
          case 'trello': {
            const count = data.count ?? data.cards?.length ?? 0;
            return `Connection OK ‚Äì retrieved ${count} Trello card${count === 1 ? '' : 's'}.`;
          }
          case 'github': {
            const count = data.count ?? data.issues?.length ?? 0;
            return `Connection OK ‚Äì loaded ${count} GitHub issue${count === 1 ? '' : 's'}.`;
          }
          default:
            return 'Connection test succeeded.';
        }
      }

      async function handleTestIntegration(card, service) {
        try {
          setIntegrationBusy(card, true);
          setIntegrationStatus(card, 'Checking connection‚Ä¶');
          const response = await fetch(`/api/integrations/${service}/pull`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });

          const body = await response.json().catch(() => ({}));
          if (!response.ok) {
            const message = body?.error || 'Unable to reach integration service.';
            throw new Error(message);
          }

          const message = summarizeIntegrationResult(service, body?.data);
          setIntegrationStatus(card, message, 'success');
        } catch (error) {
          console.error(`Integration test error for ${service}`, error);
          setIntegrationStatus(card, error.message || 'Connection test failed.', 'error');
        } finally {
          setIntegrationBusy(card, false);
        }
      }

      savePlayersBtn?.addEventListener('click', savePlayers);
      resetPlayersBtn?.addEventListener('click', resetPlayers);

      Object.values(brandInputs).forEach((input) => {
        input?.addEventListener('input', () => {
          const data = collectBrandForm(true);
          updatePreview({ ...DEFAULT_BRAND, ...data });
        });
      });

      saveBrandBtn?.addEventListener('click', saveBrand);
      resetBrandBtn?.addEventListener('click', resetBrand);

      integrationCards.forEach((card) => {
        const service = card.dataset.service;
        const saveBtn = card.querySelector('.integration-save');
        const disconnectBtn = card.querySelector('.integration-disconnect');
        const testBtn = card.querySelector('.integration-test');

        saveBtn?.addEventListener('click', () => handleSaveIntegration(card, service));
        disconnectBtn?.addEventListener('click', () => handleDisconnectIntegration(card, service));
        testBtn?.addEventListener('click', () => handleTestIntegration(card, service));
      });

      loadPlayers();
      loadBrand();
      refreshIntegrationCards();
    })();
  </script>
</body>

</html>